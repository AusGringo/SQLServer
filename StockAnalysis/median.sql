DECLARE @i INT

WITH Median AS(
	SELECT Date
	, Price
	, ROW_NUMBER() OVER (ORDER BY Price DESC) PD
	FROM HistoricalData
)
SELECT Price
	, PD
	, ROW_NUMBER() OVER (ORDER BY PD DESC) PA
INTO ##Median
FROM Median

SELECT @i = COUNT(*) FROM ##Median
SELECT @i = @i%2

IF @i = 1
BEGIN
	SELECT *
	FROM ##Median
	WHERE PD = PA
END
ELSE
BEGIN
	SELECT *
	FROM ##Median
	WHERE PD BETWEEN (PA - 1) AND (PA + 1)
END

DROP TABLE ##Median
